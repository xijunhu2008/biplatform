epr={account:"fefeding",lan:"zh-CN",apps:{},cache:{},isServerPager:!1,app:{ProductionId:"",ProductionCode:"",pages:{}},loadApp:function(e,t){this.apps[e]&&(this.app=this.apps[e]);if(this.app&&e==this.app.ProductionId&&this.app.ProductionCode){t(this.app);return}jmreport.proxy.production.get(e,function(e,n){e&&(typeof e=="string"&&(e=JSON.parse(e)),e.ProductionId=e.ID||e.appId,jmreport.apps[e.ProductionId]=e,jmreport.app=e,e.pages={},t&&t())})}},jmreport.page=function(e,t){t=t||{},this.contentContainer=t.content||$("#jmreport-page-content"),this.toolbarContainer=t.toolbar||$("#jmreport-page-toolbar"),this.titleContainer=t.title||$("#jmreport-page-title"),this.noticeContainer=$("#jmreport-page-notice"),this.completeCallback=t.completeCallback||function(){},jmreport.currentPage||$(window).bind("resize",function(){jmreport.currentPage.rebind()});var n=this;this.pageId=e,this.params=getUrlParams(),this.load=function(){jmreport.app.pages||(jmreport.app.pages={});if(jmreport.app.pages[this.pageId]){this.initPage(jmreport.app.pages[this.pageId]),this.completeCallback();return}var e=this;jmreport.proxy.page.getById(this.pageId,function(t,n){t?(jmreport.app.pages[e.pageId]=t,e.initPage(t,e.completeCallback)):message.error(n||"加载页面失败"),e.completeCallback()})},this.createPageTitle=function(e){var t=this;this.titleContainer.empty(),this.pageRefresh=$('<ul class="jmreport-pageMenu" ><li class="jmreport-pageMenu-icon refresh" ></li><li class="jmreport-pageMenu-content" >页面刷新</li></ul>');var n=function(){var n=top.$("#selpro").find("span").html()||"",r=top.$("a.menu.menu-current");for(var i=0;i<r.length;i++)n+=(n?">":"")+$.trim($(r[i]).text());n+=(n?">":"")+e.PageName,t.pageRefresh.appendTo(t.titleContainer),$('<div class="jmreport-pageTitle" >'+n+"</div>").appendTo(t.titleContainer)};setTimeout(n,1e3)},this.notice={noticeInterval:null,contents:[],buttons:[],intervalIndex:0,intervalDelay:5e3,init:function(e){this.noticeInterval&&clearInterval(this.noticeInterval),this.contents=[],this.buttons=[];for(var t=0;t<e.length;t++){var n="";t==0&&(n='class="alt-point"'),this.contents.push($("<li content-index='"+t+"' ><a target='_blank' href="+e[t].Url+" >"+e[t].Title+"</a></li>")),this.buttons.push($("<li "+n+' button-index="'+t+'"  ></li>'))}this.appendItems(),this.runNotice(),this.bindEvents()},appendItems:function(){var e=$(n.noticeContainer).find(".notice-right-content"),t=$(n.noticeContainer).find(".little-point");e.empty(),t.empty();for(var r=0;r<this.contents.length;r++)this.contents[r].appendTo(e),this.buttons[r].appendTo(t)},runNotice:function(){var e=this,t=function(){e.runFunction.call(e)};this.noticeInterval=setInterval(t,this.intervalDelay)},runFunction:function(){this.intervalIndex>this.contents.length-1&&(this.intervalIndex=0);var e=$(n.noticeContainer).find(".notice-right-content");e.animate({top:0-this.intervalIndex*40},500);for(i in this.buttons)this.buttons[i].removeAttr("class");this.buttons[this.intervalIndex].attr("class","alt-point"),this.intervalIndex++},bindEvents:function(){var e=this;for(var t in this.contents)this.contents[t].mouseover(function(){clearInterval(e.noticeInterval)}),this.contents[t].mouseout(function(){e.runNotice()});for(t in this.buttons)this.buttons[t].mouseover(function(){clearInterval(e.noticeInterval);for(t in e.buttons)e.buttons[t].removeAttr("class");$(this).attr("class","alt-point");var r=$(n.noticeContainer).find(".notice-right-content");r.stop(),r.animate({top:0-Number($(this).attr("button-index"))*40},500)}),this.buttons[t].mouseout(function(){e.runNotice()})}},this.initPage=function(e,t){this.config=e,this.createPageTitle(e);var n=this;jmreport.proxy.reportData.getNoticeData(function(e){n.notice.init(e)}),this.pageRefresh.click(function(){n.getData()}),this.reports=[];var r;this.contentContainer.html("");var i=function(e,t){for(var n=0;n<e.Controls.length;n++)e.Controls[n].controlLoadCompletedCallBack=t;return e};if(e.Reports&&e.Reports.length>0){var s=this.contentContainer,o=e.Reports.length;o>1&&(r=$('<div class="jmreport-tabs-content" ></div>').appendTo(this.contentContainer),s=$("<ul></ul>").appendTo(r));for(var u=0;u<o;u++){var a=s,f=e.Reports[u];if(typeof this.selectReportHandler=="function"&&this.selectReportHandler(f)==0)continue;var l="reports-"+u;o>1&&($('<li><a href="#'+l+'" data-tag-item = "data-tag-item" data-index="'+u+'">'+f.TabName+"</a></li>").appendTo(s),a=$('<div id="'+l+'" class="jmreport-content-tabitem"></div>').appendTo(r)),f=i(f,t);var c=new this.report(a,f);c.index=u,c.page=this,this.reports.push(c),c.render(),this.currentReport||(this.currentReport=c)}o>1&&r.tabs({activate:function(e,t,n){var r=$(t.newTab.context).attr("data-index"),i=jmreport.currentPage.reports[r];i&&(jmreport.currentPage.currentReport=i,i.rebind())}})}this.toolbar=new this.toolbar(this.toolbarContainer,e.Toolbar),this.toolbar.page=this,this.toolbar.completeCallback=function(){this.page.config.Toolbar&&this.page.config.Toolbar.IsDefaultSearch&&this.page.getData()},this.toolbar.render(),this.renderCallback&&this.renderCallback()},this.getParams=function(){return this.toolbar.getParams()},this.getFilterParams=function(){return this.toolbar.getFilterParams()},this.getData=function(){if(this.reports)for(var e=0;e<this.reports.length;e++)this.reports[e].getData()},this.rebind=function(){this.currentReport&&this.currentReport.rebind()},this.openPopPage=function(e,t,n,r){e=$.trim(e.toLowerCase());if(this.openPageHandler){var i=this.openPageHandler.call(this,e,t,n);if(i===!1)return}if(e.indexOf("http://")==0||e.indexOf("https://")==0)window.open(e);else{this.popPage||(this.popPage=$('<div class="jmreport-poppage"></div>'),this.popPage.css("overflow","hidden"),$("<iframe></iframe>").appendTo(this.popPage),this.popPage.appendTo("body"),this.popPage.dialog({autoOpen:!1,modal:!0,width:"80%",height:$(window).height()/10*9}));var s=top.poppageUrl+"?app="+jmreport.app.ID+"&page="+e,n=this.getParams();if(n&&n.length>0)for(var o=0;o<n.length;o++)s+="&"+n[o].ColumnName+"="+encodeURIComponent(n[o].Value);r&&(s+="&pagePar="+r),this.popPage.find("iframe").attr("src",s),this.popPage.dialog({height:$(window).height()/10*9,title:t,closeOnEscape:!0}),this.popPage.dialog("open"),$(".ui-widget-overlay").bind("click",function(){$(".ui-dialog-titlebar-close").click()}),$("div.ui-dialog.ui-widget.ui-widget-content.ui-corner-all.ui-front.ui-draggable.ui-resizable").css("position","fixed").css("top","5%")}},this.closePopPage=function(){this.popPage&&this.popPage.hide()},this.toolbar=function(e,t){this.target=e,this.config=t,t.IsShowToolbar==0&&this.target.hide(),this.state="initing",this.childrenPageParFinder=function(e){getUrlParams()[e.ToolbarPara]&&(e.DefalutValue=$.trim(window.decodeURI(getUrlParams()[e.ToolbarPara])));if(getUrlParams().pagePar){var t=JSON.parse($.trim(window.decodeURI(getUrlParams().pagePar)));e.ToolbarPara==":"+t.name&&(e.DefalutValue=t.value)}return e},this.render=function(){this.target.html(""),this.controls=[];var e=$('<div class="controls"></div>').appendTo(this.target);if(this.config.Controls&&this.config.Controls.length>0){this.panels={};for(var t=0;t<this.config.Controls.length;t++){var n=this.config.Controls[t];n=this.childrenPageParFinder(n),n.toolbar=this;var r=Math.floor(n.Seq/10),i=jmreport.toolbarControls.create(n);if(!i){message.error("获取工具栏控件:"+n.Control.ControlName+" 失败");continue}i.toolbar=this,this.controls.push(i);var s=this.panels[r];s||(s=$('<ul class="jmreport-controls" ></ul>').appendTo(e),this.panels[r]=s),n.Width>=0&&i.appendTo($('<li class="jmreport-controls-item" ></li>').appendTo(s)),i.state!="completed"&&(i.bindComplete=function(){this.toolbar.complete()},i.getData())}}var o=this;this.button=$('<li class="jmreport-controls-submit" >查询</li>').appendTo(s).click(function(){return jmreport.proxy.abort(),o.page.getData(),!1}),this.complete()},this.getParams=function(){var e=[];e.push({ColumnName:"sys_appid",Value:jmreport.app.ProductionId}),e.push({ColumnName:"sys_appname",Value:jmreport.app.ProductionName}),e.push({ColumnName:"sys_appcode",Value:jmreport.app.ProductionCode}),e.push({ColumnName:"sys_local",Value:jmreport.lan.replace("-","_")}),e.push({ColumnName:"sys_user",Value:jmreport.account}),e.push({ColumnName:"sys_permission",Value:jmreport.account});if(this.page.params)for(var t in this.page.params)t.indexOf(":")==0&&e.push({ColumnName:t,Value:this.page.params[t]});var n=this.controls;if(n&&n.length>0)for(var r=0;r<n.length;r++){var i=n[r],s=i.getValues();for(var o=0;o<s.length;o++){var u=s[o],a=null;for(var f=0;f<e.length;f++)if(e[f].ColumnName==u.key){a=e[f];break}a?a.Value=u.value:(a={ColumnName:u.key,Value:u.value},e.push(a))}}return e},this.getFilterParams=function(){var e=[],t=this.controls;if(t&&t.length>0)for(var n=0;n<t.length;n++){var r=t[n],i=r.config.getControlParam("ShieldedValue");if(i==undefined)continue;var s=r.getValues();if(s&&s.length>0)for(var o=0;o<s.length;o++)e.push({key:s[o].key,value:i})}return e},this.complete=function(){if(this.state!="completed"){for(var e=0;e<this.controls.length;e++){var t=this.controls[e];if(t.state!="completed")return!1}this.state="completed",this.completeCallback&&this.completeCallback()}}},this.report=function(e,t){this.config=t,this.target=e,e.html(""),this.grid=$('<table cellpadding="0" cellspacing="0" class="jmreport-template"></table>').appendTo(e),this.getData=function(){if(this.controls)for(var e=0;e<this.controls.length;e++)this.controls[e].getData()},this.rebind=function(){if(this.controls)for(var e=0;e<this.controls.length;e++){var t=this.controls[e];t.bind&&t.bind()}},this.render=function(){this.grid.html("");if(this.page.renderReport){this.page.renderReport.call(this);return}var e=this.config.Template.Content.match(/\<ColumnDefinition\s+[\s\S]*?\/\>/ig),t=/\d+/,n=[],r=0;if(e)for(var i=0;i<e.length;i++){var s=e[i],o=t.exec(s),u="auto";o&&(u=o[0],r+=Number(u)),n.push({width:u})}else n.push({width:"auto"});var a=this.config.Template.Content.match(/\<RowDefinition\s+[\s\S]*?\/\>/ig);this.rows=[];if(a)for(var i=0;i<a.length;i++){var f=a[i],l=$("<tr></tr>");this.rows.push(l);var c=t.exec(f);c&&l.css("height",c[0]+"%"),l.columns=[];for(var h=0;h<n.length;h++){var p=$('<td  valign="top"></td>'),u=n[h].width;r>0&&Number(u)&&(u=u/r*100),p.attr("data-width",u),l.columns.push(p),p.appendTo(l)}l.appendTo(this.grid)}this.renderControl()},this.createControl=function(e){var t=jmreport.reportControls.create(e);if(t==null){message.error("加载报表控件: "+e.Control.ControlName+" 失败");return}return this.controls||(this.controls=[]),this.controls.push(t),t.report=this,t},this.renderControl=function(){var e=this.config.Template.Content.match(/\<Border\s+[\s\S]*?\/\>/ig),t=/\d+/,n=/Name\s*=\s*"[^"]*"/i,r=/"[^"]*"/i,i=/Grid\.Row\s*=\s*"\d+"/i,s=/Grid\.Column\s*=\s*"\d+"/i,o=/Grid\.ColumnSpan\s*=\s*"\d+"/i,u=/Grid\.RowSpan\s*=\s*"\d+"/i;if(e)for(var a=0;a<e.length;a++){var f=e[a],l="",c=n.exec(f);c&&(c=r.exec(c[0]),c&&(l=c[0].trim('"')));var h=0,p=i.exec(f);p&&(p=t.exec(p[0]),p&&(h=Number(p[0])));var d=0,v=s.exec(f);v&&(v=t.exec(v[0]),v&&(d=Number(v[0])));var m=0,v=o.exec(f);v&&(v=t.exec(v[0]),v&&(m=Number(v[0])));var g=0,p=u.exec(f);p&&(p=t.exec(p[0]),p&&(g=Number(p[0])));var y=null;for(var b=0;b<this.config.Controls.length;b++){var w=this.config.Controls[b];if(w&&l==w.BindingSourceName){y=w;break}}if(y==null)continue;var E=this.createControl(y),S=h<this.rows.length?this.rows[h]:null;if(S&&d<S.columns.length){var x=S.columns[d];if(g){x.attr("rowspan",g);if(g>1)for(var w=1;w<g;w++){var T=h+w;if(this.rows.length<=T)break;var N=this.rows[T],C=w;if(N&&m)for(var w=0;w<m;w++){var k=d+w;if(N.columns.length<=k)break;var L=N.columns[k];L&&L.remove()}w=C}}if(m){var A=Number(x.attr("data-width"))||0;if(m>1)for(var w=1;w<m;w++){var k=d+w;if(S.columns.length<=k)break;var L=S.columns[k];if(L){var O=Number(L.attr("data-width"));O&&(A+=O),L.remove()}}x.css("width",A+"%"),x.attr("colspan",m)}E.appendTo(x)}else E.appendTo(this.grid)}}}},jmreport.helper={},jmreport.helper.convertUnit=function(e){return typeof e=="string"&&(e=Number(e)),e>=1e8?(e/=1e8,e=e.toFixed(2)+"<em>亿</em>"):e>=1e7?(e/=1e7,e=e.toFixed(2)+"<em>千万</em>"):e>=1e6?(e/=1e6,e=e.toFixed(2)+"<em>百万</em>"):e>=1e4&&(e/=1e4,e=e.toFixed(2)+"<em>万</em>"),e},jmreport.helper.tmpl=function(e,t){var n=jmreport.cache["jmreport.template.caches"]||(jmreport.cache["jmreport.template.caches"]={}),r=/\W/.test(e)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):n[e]=n[e]||jmreport.helper.tmpl(document.getElementById(e).innerHTML);return t?r(t):r},jmreport.lans={datePicker:{zh:{closeText:"关闭",prevText:"&#x3C;上月",nextText:"下月&#x3E;",currentText:"今天",monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],monthNamesShort:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],dayNames:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],dayNamesShort:["周日","周一","周二","周三","周四","周五","周六"],dayNamesMin:["日","一","二","三","四","五","六"],weekHeader:"周",dateFormat:"yy-mm-dd",firstDay:1,isRTL:!1,showMonthAfterYear:!0,yearSuffix:"年"}}},jmreport.proxy={requestParams:"",ajaxCache:[],request:function(e,t,n){typeof t=="function"&&(n=t,t=null),t||(t={}),t.par||(t.par=JSON.stringify({UserName:jmreport.account,Localication:jmreport.lan,ProductionId:jmreport.app.ProductionId||jmreport.app.appId||jmreport.app.ID,ProductionType:jmreport.app.ProductionType,ProductionCode:jmreport.app.ProductionCode,IsFramework:jmreport.currentPage&&jmreport.currentPage.config?jmreport.currentPage.config.FramworkId=="0":!1}));var r=$.ajax({type:"post",data:t,url:oap.rootUrl+"Servers/ReportData.ashx?cmd="+e+"&culture="+(jmreport.lan||oap.lan.name)+this.requestParams,success:function(e){if(e){if(e==-1){window.location.reload();return}try{n(e)}catch(t){message.error(t.message),n(null,t)}}else n(null,e)},error:function(e){if(e&&e.statusText=="abort"){window.console&&window.console.log&&window.console.log(e);return}n(null,e)}});this.ajaxCache.push(r)},abort:function(e){if(typeof e!="undefined"){var t=this.ajaxCache.length>e?this.ajaxCache[e]:null;t&&t.status!==200&&t.readyState!==4&&t.abort(),this.ajaxCache.splice(e,1)}else for(var n=this.ajaxCache.length-1;n>=0;n--)this.abort(n)},page:{"class":"TX.OAPServer.Bll.MenuAndPageApp",getById:function(e,t){jmreport.proxy.request("getpage",{pageid:e,appid:jmreport.app.ID||jmreport.app.appId},function(e,n){e&&(e=JSON.parse(e)),t(e,n)})}},menu:{getAppMenu:function(e,t){jmreport.proxy.request("getmenu",{app:e},function(e,n){e&&(e=JSON.parse(e)),t(e,n)})}},reportData:{"class":"TX.OAPServer.Bll.ReportDataApp",getData:function(e,t,n,r,i,s,o,u,a){var f={};if(s){var l=s;s="";for(var c=0;c<l.length;c++)s+=l[c].key+";"+l[c].value+"|"}var h={BindingSourceName:o,CacheTimeout:3600,DataParamType:0,IsRunLogic:!0,DataSourceId:t,FilterCondition:i,ControlCodition:s,LogicCodintion:r,LogicName:n,SqlId:e,MaxCount:2e3};f.datapar=JSON.stringify(h),jmreport.proxy.request("getdata",f,a)},getDataRowCount:function(e,t,n,r,i,s,o,u,a,f,l){var c={},h={BindingSourceName:a,CacheTimeout:3600,DataParamType:0,IsRunLogic:!0,DataSourceId:i,FilterCondition:u,LogicCodintion:o,LogicName:s,SqlId:r,MaxCount:2e3,PageIndex:n,PageSize:t,TotleRowCount:totleRowCount};c.datapar=JSON.stringify(h),jmreport.proxy.request("getdatabypage",c,l)},exportData:function(e,t,n,r,i,s,o,u,a,f){var l={},c=JSON.stringify({BindingSourceName:u,CacheTimeout:3600,DataParamType:0,IsRunLogic:!0,DataSourceId:r,FilterCondition:o,LogicCodintion:s,LogicName:i,SqlId:n,MaxCount:2e3});l=JSON.stringify({UserName:jmreport.account,Localication:jmreport.lan,ProductionId:jmreport.app.ProductionId||jmreport.app.appId||jmreport.app.ID,ProductionType:jmreport.app.ProductionType,ProductionCode:jmreport.app.ProductionCode,IsFramework:jmreport.currentPage&&jmreport.currentPage.config?jmreport.currentPage.config.FramworkId=="0":!1});if(!this.form){var h=oap.rootUrl+"Servers/ReportData.ashx?cmd=exportdata";this.form=$('<form target="_blank" method="post" style="display:none;" action="'+h+'"></form>').appendTo("body"),this.parinput=$('<input type="text" name="par" />').appendTo(this.form),this.titleinput=$('<input type="text" name="title" />').appendTo(this.form);var p=$('<input type="text" name="exportdatatype" />').appendTo(this.form);this.dataparinput=$("<input type='text' name='dataPar' />").appendTo(this.form)}this.dataparinput.val(c),this.parinput.val(l),this.titleinput.val(t),$(p).val(e),this.form.submit(),this.form.remove(),this.form=undefined},getNoticeData:function(e){$.ajax({type:"POST",url:oap.rootUrl+"Home/GetPublishes",data:null,contentType:"application/x-www-form-urlencoded;charset=UTF-8",async:!1,error:function(e){window.console&&window.console.info&&window.console.info("获取公告失败")},success:function(t){var n=$.parseJSON(t);e(n)}})}},production:{"class":"TX.OAPServer.Bll.ProductionApp",get:function(e,t){jmreport.proxy.request("getproduction",{appid:e},t)}}},jmreport.toolbarControls={controlTypes:{},controls:{},register:function(e,t){this.controls[e]=t},create:function(e){e=new this.controlConfig(e);var t=this.controls[e.config.Control.ControlName];if(t)return new t(e)},controlConfig:function(e){this.config=e,this.getControlParam=function(e){if(!this.params){this.params={};if(this.config.ControlPara){var t=this.config.ControlPara.split("|"),n=t.length;for(var r=0;r<n;r++){var i=t[r];if(!i)continue;var s=i.split("=");s.length>=2&&(this.params[s[0].toLowerCase()]=s[1])}}}return e=e.toLowerCase(),this.params[e]},this.getDefaultDate=function(e){var t=new RegExp("^[0-9]{4,4}-[0-9]{2,2}-[0-9]{2,2}|^[0-9]{2,2}-[0-9]{2,2}|^([0-9]{2,2}:)");if(t.test(this.config.DefalutValue)){var n=parseDate(this.config.DefalutValue);if(n.toString()!="Invalid Date")return[this.config.DefalutValue]}var r=this.dateFormat||"yyyy-MM-dd",i=new Date;if(e.defaultValues){var s=[];if(e.defaultValues.length>0)for(var o=0;o<e.defaultValues.length;o++){var u=e.defaultValues[o];if(!u)continue;var a=u.split("-");if(a.length>0){var f=a.length>1?Number(a[1]):0,l=i.valueOf();switch(a[0].toLowerCase()){case"m":f=f*30*24*60*60*1e3;break;case"h":f=f*60*60*1e3;break;case"s":f*=1e3;break;case"y":f=f*365*12*30*24*60*60*1e3;break;case"d":f=f*24*60*60*1e3}l-=f;var c=new Date(l);s.push(formatDate(c,r))}else s.push(u)}return s}return[formatDate(i,r)]}}},jmreport.toolbarControls.init=function(){jmreport.toolbarControls.controlTypes.initControl=function(e){this.appendToContainer=function(e){var t=$('<div  class="jmreport-toolbar-singl-item" ></div>').appendTo(this.container);return e.appendTo(t)},this.config=e,this.state="completed",this.container=$('<div class="jmreport-toolbar-singl" ></div>'),this.label=this.appendToContainer($('<label class="jmreport-toolbar-lable"></label>').html(e.config.DisplayName)),this.getValues=function(){return this.values},this.appendTo=function(e){this.container.appendTo(e)},this.bindValueChange=function(e,t){this.valueChangeHandles||(this.valueChangeHandles=[]),this.valueChangeHandles.push({target:e,callback:t})},this.raiseValueChange=function(){if(this.valueChangeHandles)for(var e=0;e<this.valueChangeHandles.length;e++){var t=this.valueChangeHandles[e];t.callback.call(t.target,!0)}},this.error=function(e){this.container.html(e)},this.log=function(e){this.container.html(e)},this.getData=function(e){var t=this.config.config.ControlSqlId,n=this.config.config.DbDataSourceId,r=this.config.config.LogicName,i=this.config.config.LogicPara,s=this.config.config.BindingSourceName,o=this.toolbar.page.config.FramworkId=="0";this.params=this.toolbar.page.getParams(),this.filter=this.toolbar.page.getFilterParams();var u=this;jmreport.proxy.reportData.getData(t,n,r,i,this.params,this.filter,s,o,function(t,n){t?(typeof t=="string"&&(t=JSON.parse(t)),u.bind(t,e),u.state="completed",u.bindComplete()):this.error(n||"获取数据出错")})},this.exportData=function(){},this.requires=[],this.defaultValues=[],this.values=[];var t=this.toolbar||this.config.config.toolbar;if(e.config.ToolbarPara){var n=e.config.ToolbarPara.split(";");for(var r=0;r<n.length;r++){var i=n[r],s=t.page.params?t.page.params[i]:"";this.values.push({key:i,value:s}),s&&this.defaultValues.push(s)}}if(e.config.DefalutValue){var o=e.config.DefalutValue.split(";");for(var r=0;r<o.length;r++){var u=o[r];if(!u)continue;if(u.indexOf(":")==0)for(var a=0;a<t.controls.length;a++){var f=t.controls[a];for(var l=0;l<f.values.length;l++)if(f.values[l].key==u){f.bindValueChange(this,this.getData),this.requires.push(f);break}}else this.defaultValues.push(u)}}}},jmreport.toolbarControls.init(),jmreport.toolbarControls.controlTypes.checkBoxList=function(e){jmreport.toolbarControls.controlTypes.initControl.call(this,e),this.controlId=(+(new Date)/Math.random()).toString().replace(".",""),this.state="loading",this.element=this.appendToContainer($('<div value="" id="jmreport_mControl_'+this.controlId+'" class="jmreport-CheckBoxList" ></div>')),this.rightSide=$('<div class="jmreport-CheckBoxList-right" > > </div>').appendTo(this.element),this.leftSide=$('<div class="jmreport-CheckBoxList-left" ></div>').appendTo(this.element),this.absoluteLay=$('<div class="jmreport-CheckBoxList-absoluteLay" ><div class="title" ><a onclick="$(document).click();" >【关闭】</a></div>').appendTo("body"),this.leftSide.append('<span style="color:#ABADB3" title="请点击此处选择.." >请点击此处选择..</span> ');var t=this;this.config.config.Width&&this.leftSide.css("max-width",this.config.config.Width+"px"),this.bind=function(e){if(e.Tables.length>0&&e.Tables[0].Rows.length>0){var n=tb.Columns[0].DataType.indexOf("string")!=-1||tb.Columns[0].DataType.indexOf("String")!=-1;for(var r=0;r<e.Tables[0].Rows.length;r++)var i=$("<span><input jmreport_con_id='"+this.controlId+"' type='checkbox' displayValue='"+e.Tables[0].Rows[r].ItemArray[1].Value+"' dataType='"+(n?"string":"number")+"' value='"+e.Tables[0].Rows[r].ItemArray[0].Value+"' />"+e.Tables[0].Rows[r].ItemArray[1].Value+"</span>").appendTo(this.absoluteLay);this.absoluteLay.find("input[type=checkbox]").click(function(){t.comboBoxClick(this)});if(this.defaultValues&&this.defaultValues.length>0){var s=this.defaultValues[0];s=s.split(",");for(var r=0;r<s.length;r++){var s=this.absoluteLay.find("input[value="+s[r].trim("'")+"]");for(var o=0;o<s.length;o++)$(s[o]).attr("checked","checked"),t.comboBoxClick(s[o])}}else{var s=this.absoluteLay.find("input[type=checkbox]");$(s[0]).attr("checked","checked"),t.comboBoxClick(s[0])}}},this.comboBoxClick=function(e){var t=$("[jmreport_con_id="+$(e).attr("jmreport_con_id")+"]"),n="",r="";for(var i=0;i<t.length;i++)t[i].checked&&(n!=""&&(n+="，",r+=","),n+=$(t[i]).attr("displayValue"),$(t[i]).attr("dataType")=="number"?r+=$(t[i]).val():r+="'"+$(t[i]).val()+"'");var s="<label>"+n+"</label>";n==""?(s='<span style="color:#ABADB3" >请点击此处选择..</span> ',n="请点击此处选择.."):n="选中值为："+n;var o=$("#jmreport_mControl_"+$(e).attr("jmreport_con_id")).find(".jmreport-CheckBoxList-left");o.html(s),o.attr("title",n),$("#jmreport_mControl_"+$(e).attr("jmreport_con_id")).attr("value",r)},this.absoluteLay.click(function(e){e.stopPropagation()}),this.element.click(function(e){function i(){$(r).slideUp(300),$(document).unbind("click",i)}var n=t.absoluteLay;n.css("display","block").css("left",$(this).position().left+"px").css("top",$(this).position().top+($(this).height()||24)+"px"),n.css("display","none").slideDown(300);var r=n;$(document).click(i),e.stopPropagation()}),this.getValues=function(){return this.values[0].value=this.element.attr("value"),this.values}},jmreport.toolbarControls.register("CheckComboBox",jmreport.toolbarControls.controlTypes.checkBoxList),jmreport.toolbarControls.controlTypes.comboBoxOne=function(e){jmreport.toolbarControls.controlTypes.initControl.call(this,e),this.state="loading",this.element=this.appendToContainer($("<select></select>")),this.config.config.Width&&this.element.width(this.config.config.Width);var t=this;this.changeEvent=function(){t.raiseValueChange()},this.bind=function(e,t){if(e.HasError||e.Tables[0].Rows.length==0)return;this.element.html("");if(e.Tables&&e.Tables.length>0&&e.Tables[0].Rows&&e.Tables[0].Rows.length>0){var n=e.Tables[0];for(var r=0;r<n.Rows.length;r++){var i=n.Rows[r],s=i.ItemArray[0].Value,o=i.ItemArray[1].Value,u=$("<option></option>").html(o).attr("value",s).appendTo(this.element);if(this.defaultValues&&this.defaultValues.length>0){var a=this.defaultValues[0];(s==a||o==a)&&u.attr("selected",!0)}}}this.element.unbind("change",this.changeEvent),t||this.raiseValueChange(),this.element.bind("change",this.changeEvent)},this.getValues=function(){var e=this.values[0];e.value=this.element.val();var t=this.element.find("option:selected").text(),n={key:e.key+"Text",value:t},r=e.key.match(/\d?$/);if(r){var i={value:t};return i.key=e.key.replace(r,"")+"Text"+r,[n,i,e]}return[n,e]}},jmreport.toolbarControls.register("ComboBoxOne",jmreport.toolbarControls.controlTypes.comboBoxOne),jmreport.toolbarControls.controlTypes.dateTimeOne=function(e){jmreport.toolbarControls.controlTypes.initControl.call(this,e),this.element=this.appendToContainer($('<input type="text" />')),this.config.config.Width&&this.element.width(this.config.config.Width),this.element.datepicker({changeMonth:!0}).datepicker("option",jmreport.lans.datePicker.zh);var t=e.getDefaultDate(this);t.length>0?this.element.val(t[0]):this.element.val(formatDate(null,"yyyy-MM-dd")),this.getValues=function(){return this.values[0].value=this.element.val(),this.values}},jmreport.toolbarControls.register("DateTimeOne",jmreport.toolbarControls.controlTypes.dateTimeOne),jmreport.toolbarControls.controlTypes.dateTimeTwo=function(e){jmreport.toolbarControls.controlTypes.initControl.call(this,e),this.element1=this.appendToContainer($('<input type="text" />')),this.appendToContainer($("<label>至</label>")),this.element2=this.appendToContainer($('<input type="text" />'));var t=this,n={changeMonth:!0,numberOfMonths:2,onClose:function(e){t.element2.datepicker("option","minDate",e)}},r={changeMonth:!0,numberOfMonths:2,onClose:function(e){t.element1.datepicker("option","maxDate",e)}};this.element1.datepicker(n).datepicker("option",jmreport.lans.datePicker.zh),this.element2.datepicker(r).datepicker("option",jmreport.lans.datePicker.zh);var i=e.getDefaultDate(this);i.length>0?(this.element1.val(i[0]),i.length>1?this.element2.val(i[1]):this.element2.val(formatDate(null,"yyyy-MM-dd"))):(this.element1.val(formatDate(null,"yyyy-MM-dd")),this.element2.val(formatDate(null,"yyyy-MM-dd"))),this.getValues=function(){return this.values[0].value=this.element1.val(),this.values[1].value=this.element2.val(),this.values}},jmreport.toolbarControls.register("DateTimeTwo",jmreport.toolbarControls.controlTypes.dateTimeTwo),jmreport.toolbarControls.controlTypes.dateTimePickerOne=function(e){jmreport.toolbarControls.controlTypes.initControl.call(this,e),this.element=this.appendToContainer($('<input type="text" />')),this.config.config.Width&&this.element.width(this.config.config.Width),$.timepicker.setDefaults($.timepicker.regional["zh-CN"]),this.element.datetimepicker({showSecond:!0,dateFormat:"yy-mm-dd",timeFormat:"hh:mm:ss",stepHour:1,stepMinute:1,stepSecond:1}),e.dateFormat="yyyy-MM-dd HH:mm:ss";var t=e.getDefaultDate(this);t.length>0?this.element.val(t[0]):this.element.val(formatDate(null,"yyyy-MM-dd HH:mm:ss")),this.getValues=function(){return this.values[0].value=this.element.val(),this.values}},jmreport.toolbarControls.register("DateTimePickerOne",jmreport.toolbarControls.controlTypes.dateTimePickerOne),jmreport.toolbarControls.controlTypes.horizontalListBox=function(e){jmreport.toolbarControls.controlTypes.initControl.call(this,e),this.state="loading",this.element=this.appendToContainer($('<ul class="jmreport-horizontallistbox"></ul>')),this.config.config.Width&&this.element.width(this.config.config.Width);var t=this;this.changeEvent=function(){t.raiseValueChange()},this.bind=function(e,t){if(e.HasError||e.Tables[0].Rows.length==0)return;this.element.html(""),this.items=[];if(e.Tables.length>0&&e.Tables[0].Rows.length>0){var n=e.Tables[0],r=this,i=n.Columns[0].DataType.indexOf("string")!=-1||n.Columns[0].DataType.indexOf("String")!=-1;for(var s=0;s<n.Rows.length;s++){var o=n.Rows[s],u=o.ItemArray[0].Value,a=o.ItemArray[1].Value,f=i?"'"+u+"'":u,l=$("<li></li>").html(a).attr("data-value",f).appendTo(this.element);l.click(function(){r.select(this)}),this.items.push(l);if(this.defaultValues&&this.defaultValues.length>0){var c=this.defaultValues[0];(u==c||a==c)&&l.toggleClass("selected",!0)}else l.toggleClass("selected",!0)}}this.element.unbind("change",this.changeEvent),t||this.raiseValueChange(),this.element.bind("change",this.changeEvent)},this.select=function(e){if(typeof e=="string"){if(this.items)for(var t=0;t<this.items.length;t++){var n=this.items[t];n.attr("data-value")==e&&n.toggleClass("selected",!0)}}else if(typeof e=="object"){var n=$(e),r=n.hasClass("selected");if(r){var i=this.element.find("li[class*=selected]");if(i.length<2)return}n.toggleClass("selected",!r)}},this.getValues=function(){var e="",t=this.element.find("li[class*=selected]");return t.each(function(t,n){e+=$(n).attr("data-value")+","}),this.values[0].value=e.trim(","),this.values}},jmreport.toolbarControls.register("HorizontalListBox",jmreport.toolbarControls.controlTypes.horizontalListBox),jmreport.toolbarControls.controlTypes.monthOne=function(e){jmreport.toolbarControls.controlTypes.initControl.call(this,e),this.element=this.appendToContainer($('<input type="text" />')),this.element.attr("readonly","readonly"),this.selecter=$('<div class="jmreport-toobarMonthOne-selecter"></div>').bind("mouseup",function(){return!1}).hide().appendTo("body");var t=this,n=$('<div class="yearheader"></div>').appendTo(this.selecter);$('<a href="#" class="pre">上一年</a>').click(function(){return t.year-=1,t.getVal(),!1}).appendTo(n),this.thisYearDisplay=$('<span class="thisyear" >当年</span>').appendTo(n),$('<a href="#" class="next">下一年</a>').click(function(){return t.year+=1,t.getVal(),!1}).appendTo(n);var r=$('<div class="monthbody"></div>').appendTo(this.selecter);for(var i=1;i<13;i++)$('<a class="month" href="#" data-month="'+i+'">'+i+"</a>").click(function(){return t.select($(this).attr("data-month")),t.hide(),!1}).appendTo(r);this.config.config.Width&&this.element.width(this.config.config.Width),this.element.bind("mouseup",function(){return t.show(),!1}),$(document).bind("mouseup",function(){t.hide()}),this.show=function(){var e=this.element.offset();e.top+=this.element.height()+4,this.selecter.css(e),this.selecter.show(),this.selecter.animate({opacity:1})},this.hide=function(){this.selecter.animate({opacity:0},function(){t.selecter.hide()})},this.getVal=function(){return this.selecter.find("a[class*=current]").toggleClass("current",!1),this.selecter.find("a[data-month="+this.month+"]").toggleClass("current",!0),this.month.toString().length<2&&(this.month="0"+this.month),this.thisYearDisplay.html(this.year+"年"+this.month+"月"),this.year+""+this.month},this.select=function(e){this.month=e,this.element.val(this.getVal(e))};var s=e.getDefaultDate(this);if(s.length>0){var o=parseDate(s[0]);this.year=o.getFullYear(),this.select(o.getMonth()+1)}else{var o=new Date;this.year=o.getFullYear(),this.select(o.getMonth()+1)}this.getValues=function(){return this.values[0].value=this.element.val(),this.values}},jmreport.toolbarControls.register("MonthOne",jmreport.toolbarControls.controlTypes.monthOne),jmreport.toolbarControls.controlTypes.halfaYearOne=function(e){jmreport.toolbarControls.controlTypes.initControl.call(this,e),this.element=this.appendToContainer($('<input type="text" />')),this.element.attr("readonly","readonly"),this.selecter=$('<div class="jmreport-toobarhalfaYearOne-selecter"></div>').bind("mouseup",function(){return!1}).hide().appendTo("body");var t=this,n=$('<div class="yearheader"></div>').appendTo(this.selecter);$('<a href="#" class="pre">上一年</a>').click(function(){return t.year-=1,t.getVal(),!1}).appendTo(n),this.thisYearDisplay=$('<span class="thisyear" >当年</span>').appendTo(n),$('<a href="#" class="next">下一年</a>').click(function(){return t.year+=1,t.getVal(),!1}).appendTo(n);var r=$('<div class="monthbody"></div>').appendTo(this.selecter);$('<a class="month" href="#" data-month="1">上半年</a>').click(function(){return t.select($(this).attr("data-month")),t.hide(),!1}).appendTo(r),$('<a class="month" href="#" data-month="7">下半年</a>').click(function(){return t.select($(this).attr("data-month")),t.hide(),!1}).appendTo(r),this.config.config.Width&&this.element.width(this.config.config.Width),this.element.bind("mouseup",function(){return t.show(),!1}),$(document).bind("mouseup",function(){t.hide()}),this.show=function(){var e=this.element.offset();e.top+=this.element.height()+4,this.selecter.css(e),this.selecter.show(),this.selecter.animate({opacity:1})},this.hide=function(){this.selecter.animate({opacity:0},function(){t.selecter.hide()})},this.getVal=function(){return this.selecter.find("a[class*=current]").toggleClass("current",!1),this.selecter.find("a[data-month="+this.month+"]").toggleClass("current",!0),this.month.toString().length<2&&(this.month="0"+this.month),this.thisYearDisplay.html(this.year+"年"+this.month+"月"),this.year+""+this.month},this.select=function(e){this.month=e,this.element.val(this.getVal(e))};var i=e.getDefaultDate(this);if(i.length>0){var s=parseDate(i[0]);this.year=s.getFullYear(),this.select(s.getMonth()+1)}else{var s=new Date;this.year=s.getFullYear(),this.select(s.getMonth()+1)}this.getValues=function(){return this.values[0].value=this.element.val(),this.values}},jmreport.toolbarControls.register("HalfaYearOne",jmreport.toolbarControls.controlTypes.halfaYearOne),jmreport.toolbarControls.controlTypes.textBox=function(e){jmreport.toolbarControls.controlTypes.initControl.call(this,e),this.element=this.appendToContainer($('<input type="text" />')),this.config.config.Width&&this.element.width(this.config.config.Width),this.defaultValues.length>0&&this.element.val(this.defaultValues[0]),this.getValues=function(){var e=this.values[0];e.value=this.element.val();var t={key:e.key+"Text",value:e.value},n=e.key.match(/\d?$/);if(n){var r={value:e.value};return r.key=e.key.replace(n,"")+"Text"+n,[t,r,e]}return[t,e]}},jmreport.toolbarControls.register("TextBox",jmreport.toolbarControls.controlTypes.textBox),jmreport.reportControls={controlTypes:{},controls:{},colorRecorder:-1,register:function(e,t){this.controls[e]=t},create:function(e){e=new this.controlConfig(e);var t=this.controls[e.config.Control.ControlName];if(!t){t=this.controls.base;var n=new t(e);return n.getData=function(){},n.error("创建控件失败:"+e.config.Control.ControlName),n}return new t(e)},controlConfig:function(e){this.config=e,this.getControlParam=function(e){if(!this.params){this.params={};if(this.config.ControlPara){var t=this.config.ControlPara.split("|"),n=t.length;for(var r=0;r<n;r++){var i=t[r];if(!i)continue;var s=i.split("=");s.length>=2&&(this.params[s[0].toLowerCase()]=s[1])}}}return e=e.toLowerCase(),this.params[e]},this.createTopMenu=function(e){var t=this.menuItems[e.name]=$("<li></li>").attr("title",e.title).appendTo(this.menuContent);return e.handler&&t.click(e.handler),e.css&&t.toggleClass(e.css,!0),t},this.createMoreMenu=function(e,t){e.moreMenuContent||(e.moreMenuContent=$('<div class="moreMenu-content" ></div>').appendTo(e),$('<div class="moreMenu-icon" ></div>').appendTo(e.moreMenuContent),this.moreMenu=$('<ul class="moreDir-moreMenu" ></ul>').appendTo(e.moreMenuContent));var n=this.menuItems[t.name]=$("<li></li>").html(t.title).appendTo(this.moreMenu);return t.handler&&n.click(t.handler),t.css&&n.toggleClass(t.css,!0),n}},createMenu:function(e){this.menuItems={},this.menuContent.empty();var t=this;this.config.createTopMenu.call(this,{name:"refresh",title:"刷新",css:"content-control-refesh",handler:function(){t.getData()}});var n=this.config.createTopMenu.call(this,{name:"moreDir",title:"更多操作",css:"content-control-moreDir"});this.config.createMoreMenu.call(this,n,{name:"displaySql",title:"显示sql代码",handler:function(){var e=$('<div class="jmreport-poppage">'+t.data.Tables[0].Sql+"</div>");e.appendTo("body"),e.dialog({autoOpen:!1,modal:!0,width:"800",height:"450",title:"查看SQL语句   -   "+t.config.config.Title,fixed:!0}),e.dialog("open"),$(".ui-widget-overlay").bind("click",function(){$(".ui-dialog-titlebar-close").click()}),e.css("padding","20px").css("margin","0px").css("overflow-y","scroll"),$("div.ui-dialog.ui-widget.ui-widget-content.ui-corner-all.ui-front.ui-draggable.ui-resizable").css("position","fixed")}}),this.config.createMoreMenu.call(this,n,{name:"downLoadCsv",title:"导出数据(.csv)",handler:function(){t.exportData(".csv")}}),this.config.createMoreMenu.call(this,n,{name:"downLoadCsv",title:"导出数据(.xls)",handler:function(){t.exportData(".xls")}})}},jmreport.reportControls.init=function(){jmreport.reportControls.controlTypes.initControl=function(e){this.colorArr=["#42b2bd","#ff9655","#42b2bd"],jmreport.reportControls.colorRecorder==this.colorArr.length-1&&(jmreport.reportControls.colorRecorder=-1),jmreport.reportControls.colorRecorder++,this.config=e,this.container=$('<div class="single-chart-content" ></div>').attr("data-type",e.config.Control.ControlName).css("border-top","3px solid "+this.colorArr[jmreport.reportControls.colorRecorder]);var t=this;this.menu=$('<div class="content-control-menu"></div>').appendTo(this.container),this.menuContent=$('<ul class="content-control-menuContent"></ul>').appendTo(this.menu),this.title=$('<span class="content-control-title"></span>').appendTo(this.menu),this.title.html(e.config.Title),this.control=$("<div></div>").appendTo($('<div class="content-control-item"></div>').appendTo(this.container)),this.config.config.Height=="auto"&&(this.config.config.Height=350),this.config.config.Height>0&&this.control.height(this.config.config.Height),this.config.config.width>0&&this.control.width(this.config.config.width),this.createMenu=function(){jmreport.reportControls.createMenu.call(this)},this.createTitle=function(){var t=e.config.Title;if(t&&this.params)for(var n=0;n<this.params.length;n++){var r=this.params[n];t=t.replace(r.ColumnName,r.Value)}this.title.html(t)},this.appendTo=function(e){this.container.appendTo(e)},this.getHtml=function(){return this.control.html()},this.startLoading=function(){var e=$('<div class="jmreport-loading-modal"></div>').appendTo(this.control);$('<div class="jmreport-loading"></div>').appendTo(this.control)},this.config.config.controlLoadCompletedCallBack?this.drawCompleteCallBack=this.config.config.controlLoadCompletedCallBack:this.drawCompleteCallBack=function(){},this.getPageData=function(e,t,n){var r=this.config.config.ControlSqlId,i=this.config.config.DbDataSourceId,s=this.config.config.LogicName,o=this.config.config.LogicPara,u=this.config.config.BindingSourceName,a=this.report.page.config.FramworkId=="0";this.params=this.report.page.getParams();var f=this;jmreport.proxy.reportData.getDataRowCount(e,t,n,r,i,s,o,this.params,u,a,function(e,t){if(e){typeof e=="string"&&(e=JSON.parse(e)),e=f.initData(e);if(e==null)return;f.data.Tables&&f.data.Tables.length>0?f.bind&&f.bind(e,n):f.log("暂无数据哦，亲！")}else f.error(t||"获取数据出错");f.report.page.controlBindComplete&&f.report.page.controlBindComplete.call(f)})},this.getData=function(){this.startLoading();var e=this.config.config.ControlSqlId,t=this.config.config.DbDataSourceId,n=this.config.config.LogicName,r=this.config.config.LogicPara,i=this.config.config.BindingSourceName,s=this.report.page.config.FramworkId=="0";this.params=this.report.page.getParams(),this.filter=this.report.page.getFilterParams();var o=this,u=this.config.getControlParam("pagesize"),a=!1;if(!u||u=="0")a=!0;jmreport.isServerPager==1&&this.config.config.Control.ControlName=="GridViewData"&&a?(this.config.config.isServerPager=!0,jmreport.proxy.reportData.getDataRowCount(e,t,n,r,this.params,i,s,function(e,t){e?(typeof e=="string"&&(e=JSON.parse(e)),this.config.config.RowCount=e.RowCount,o.getPageData(e.RowCount,u,1)):o.error(t||"获取数据出错"),o.report.page.controlBindComplete&&o.report.page.controlBindComplete.call(o)})):jmreport.proxy.reportData.getData(e,t,n,r,this.params,this.filter,i,s,function(e,t){if(e){typeof e=="string"&&(e=JSON.parse(e)),e=o.initData(e);if(e==null)return;o.data.Tables&&o.data.Tables.length>0?o.bind&&o.bind(e):o.log("暂无数据哦，亲！")}else o.error(t||"获取数据出错");o.report.page.controlBindComplete&&o.report.page.controlBindComplete.call(o)})},this.exportData=function(e){var t=this.config.config.ControlSqlId,n=this.config.config.DbDataSourceId,r=this.config.config.LogicName,i=this.config.config.LogicPara,s=this.config.config.BindingSourceName,o=this.report.page.config.FramworkId=="0";this.params=this.report.page.getParams();var u=this.title.html();jmreport.proxy.reportData.exportData(e,u,t,n,r,i,this.params,s,o)},this.initData=function(e){this.control.html("");if(e.Message)return this.error(e.Message),null;if(e.Tables&&e.Tables.length>0)for(var t=0;t<e.Tables.length;t++){var n=e.Tables[t];n.getColumn=function(e){for(var t=0;t<this.Columns.length;t++){var n=this.Columns[t];if(n.Name==e)return n}return null},n.getColumnMapping=function(e){if(n.ColumnMapping)for(var t=0;t<n.ColumnMapping.length;t++){var r=n.ColumnMapping[t];if(e==r.ColumnName)return r}return null};for(var r=0;r<n.Rows.length;r++){var i=n.Rows[r];for(var s=0;s<i.ItemArray.length;s++){var o=i.ItemArray[s];i[o.ColumnName]=o.Value}}}return this.data=e,this.createTitle(),this.createMenu(),e},this.dataHandler={getColumnDiscription:function(e){var t=[];for(var n=0;n<e.Columns.length;n++)if(e.Columns[n].Description){var r={name:"",discription:""};r.name=e.Columns[n].DisplayName,r.discription=e.Columns[n].Description,t.push(r)}return t}},this.error=function(e){this.control.html(e)},this.log=function(e){this.control.html(e)},this.typeNameIsNumber=function(e){return e?(e=e.toLowerCase(),e.indexOf("double")!=-1||e.indexOf("float")!=-1||e.indexOf("int")!=-1||e.indexOf("int16")!=-1||e.indexOf("int32")!=-1||e.indexOf("int64")!=-1||e.indexOf("decimal")!=-1||e.indexOf("single")!=-1):!1},this.clickMenu={create:function(e,t,n){$(".eprChart_Context")&&$(".eprChart_Context").remove();var r=$('<ul class="eprChart_Context" id="eprChart_Context_'+t.controlId+'"" ></ul>').appendTo("body");for(var i=0;i<n.length;i++){var s=n[i],o=s.split("|");if(o.length>2&&o[2]!=e.field)continue;var u=$("<a></a>").appendTo($("<li></li>").appendTo(r));u.attr("data-date",e.date),u.attr("data-field",e.field),o.length>=2?(u.html(o[0]),u.attr("href",o[1])):(u.html(o[0]),u.attr("href",o[0])),u.click(function(){var e=$(this).attr("href"),t=$(this).html(),n={};return n.date=$(this).attr("data-date"),n.field=$(this).attr("data-field"),jmreport.currentPage.openPopPage(e,t,n),$(".eprChart_Context").remove(),!1})}var a=$("#eprChart_Context_"+t.controlId);a.css("left",e.x).css("top",e.y+$(document).scrollTop()).css("display","none").fadeIn(100,function(){var e=function(){$(".eprChart_Context")&&$(".eprChart_Context").stop().fadeOut(100,function(){$(".eprChart_Context").remove(),$(document).unbind("click",e)})};$(document).click(e)})}},this.linkHandler=function(e){var t=this.report.page.getParams();for(var n in t)if((new RegExp("^:")).test(t[n].ColumnName)){if(e.indexOf(t[n].ColumnName)!=-1){var r=new RegExp(t[n].ColumnName,"g");e=e.replace(r,t[n].Value)}}else{var i=":"+t[n].ColumnName;if(e.indexOf(i)!=-1){var r=new RegExp(i,"g");e=e.replace(r,t[n].Value)}}return e}},jmreport.reportControls.register("base",jmreport.reportControls.controlTypes.initControl)},jmreport.reportControls.init(),jmreport.reportControls.controlTypes.gridViewData=function(e){jmreport.reportControls.controlTypes.initControl.call(this,e),this.selecter=null,this.bind=function(e,t){function s(e,t){this.doFunc=function(){e.width()>t.control.width()?(t.control.parent().css("overflow-x","scroll"),t.control.css("overflow","hidden")):(t.control.parent().css("overflow-x",""),t.control.css("overflow","")),t.control.height(e.height())}}if(this.data.Tables[0].Rows.length<=0){this.log("暂无数据哦，亲！");return}this.selecter||(this.selecter=this.getPageSelecter()),(!t||this.config.getControlParam("isServerPager"))&&this.selecter.init(this),this.selecter.thisPage=t||1,this.selecter.create(this);var n=this.selecter.getDataScope(this.data.Tables[0]);this.config.config.combinCondition&&n.Rows.push(this.combins.init(this.config.config.combinCondition,this.data.Tables[0]));var r=this.createGridHeader(n),i=this.createTable(n,r);i.appendTo(this.control),this.tableResize=new s(i,this),this.tableResize.doFunc(),this.drawCompleteCallBack()},this.sortColumn=function(e){data=this.data.Tables[0];var t=$(e).attr("name"),n=$(e).attr("sortStyle"),r=[{reg:"^([0-9]{4,4})-([0-9]{2,2})-([0-9]{2,2})$",func:function(e){return Number(e.replace(new RegExp("-","g"),""))}},{reg:"^-{0,1}([0-9]{1,}.{0,1}[0-9]{0,})%$",func:function(e){return Number(e.replace("%",""))}}],i=function(e){e=e.toString();for(var t=0;t<r.length;t++)if((new RegExp(r[t].reg)).test(e))return r[t].func(e);return Number(e)},s={asc:function(e,n){var r=i(e[t]),s=i(n[t]);return isNaN(r)&&isNaN(s)?e[t].localeCompare(n[t]):r-s},desc:function(e,n){var r=i(n[t]),s=i(e[t]);return isNaN(r)&&isNaN(s)?n[t].localeCompare(e[t]):r-s}};!n||n=="desc"?(data.Rows=data.Rows.sort(s.asc),n="asc"):(data.Rows=data.Rows.sort(s.desc),n="desc");for(var o=0;o<data.Columns.length;o++)data.Columns[o].Name==t?data.Columns[o].sortStyle=n:data.Columns[o].sortStyle=undefined;this.data.Tables[0]=data,this.control.empty(),this.bind()},this.createTable=function(e,t){t||(t=this.createGridHeader(e));var n=$('<table cellspacing="0" cellpadding="0" border="0" class="jmreport-gridViewData"></table>'),r=$("<thead></thead>").appendTo(n),i=this,s=function(e,t){var n=$("<tr></tr>").appendTo(t),r=[],o=0;for(var u=0;u<e.length;u++){var a;e[u].recount||(a=$("<th></th>").appendTo(n).html(e[u].DisplayName),e[u].children.length>=2&&a.attr("colspan",e[u].children.length));if(e[u].children.length>0)r=r.concat(e[u].children),a.attr("class"," cos"),o++;else{var f=1;e[u].recount&&(f=e[u].recount+1,a=e[u].realNode),r.push({DisplayName:e[u].DisplayName,Description:e[u].Description,Name:e[u].Name,sortStyle:e[u].sortStyle,children:[],realNode:a,recount:f})}}if(o!=0)r=s(r,t);else for(var u=0;u<r.length;u++){var l=r[u];l.recount>=2&&l.realNode.attr("rowspan",l.recount),l.realNode.attr("name",l.Name).click(function(){(function(e){i.sortColumn.apply(i,arguments)})(this)});var c=undefined;if(l.realNode.html().indexOf("\n")!=-1){var h=l.realNode.html().replace("\n","^"),p=h.split("^");l.realNode.html(""),$("<p>"+p[0]+"</p>").appendTo(l.realNode),c=$("<p>"+p[1]+"</p>").appendTo(l.realNode),l.realNode.attr("class","jmreport-mulLineTh")}if($.trim(l.Description)!=""&&!(new RegExp('^([[{"]{1,1})')).test(l.Description)){var d="<span class='cDescription' title='"+l.Description+"' >?<span>";c?$(d).appendTo(c):l.realNode.html(l.realNode.html()+d)}l.sortStyle&&(l.sortStyle=="asc"?l.realNode.html(l.realNode.html()+"&nbsp;&nbsp;↑"):l.realNode.html(l.realNode.html()+"&nbsp;&nbsp;↓"),l.realNode.attr("sortStyle",e[u].sortStyle));if(l.DisplayName.indexOf("率")!=-1||l.DisplayName.indexOf("%")!=-1)l.isDisplayPre=!0}return r},o=s(t,r),u=$("<tbody></tbody>").appendTo(n),a=0;this.selecter.pageSize!=0?a=this.selecter.pageSize:a=e.Rows.length;for(var f=0;f<a;f++){var l=$("<tr></tr>").appendTo(u);f%2&&l.attr("class","alt-row");if(!e.Rows[f]){for(var c=0;c<o.length;c++)var h=o[c],p=$("<td>&nbsp;</td>").appendTo(l);continue}var d=e.Rows[f];for(var c=0;c<o.length;c++){var h=o[c],p=$("<td></td>").appendTo(l);for(var v=0;v<d.ItemArray.length;v++){var m=d.ItemArray[v];if(m.ColumnName==h.Name){var g=p,y=i.config.config.LinkPageID;y&&v==0&&(g=this.linkHandle.singleLink(y,g,d,h,p,i));if((new RegExp('^([[{"]{1,1})')).test(h.Description)){var b=JSON.parse(h.Description);if((new RegExp("^([http://]{1,1})")).test(b[0].page))g=$('<a href="'+this.linkHandler(b[0].page,d.ItemArray)+'" ></a>').attr("target","_blank").appendTo(p);else{g=$('<a href="#"></a>').attr("data-date",m.Value).attr("data-page",b[0].page).attr("data-column",h.Name).appendTo(p);var w='{"name":"'+m.ColumnName+'","value":"'+m.Value+'"}';(function(e,t,n,r,i){n.click(function(n){var s=t;return s.report.page.openPopPage(i,e,undefined,r),!1})})("",i,g,w,b[0].page)}}if(m.Value){m.combinType?(p.html(""),p.append("<div>"+m.Value+"</div>"),p.attr("class","combin")):g.append(m.Value);if(h.isDisplayPre||m.Value.indexOf("%")!=-1){var E=Number(m.Value.replace("%",""));if(!isNaN(E)){var S="",x="",T=E;E<0&&(T=E.toString().replace("-",""),S="background-color:#fbd0bd",x="color:#ed561b"),g.html(""),g.append("<div class='preValue' style='"+x+"' >"+m.Value+"</div>"),$("<div class='DisplayPre' style='width:0%;"+S+"' ><div>").appendTo(p).animate({width:T+"%"},1e3),g.attr("class","DisplayPre")}}}else g.html("&nbsp;");break}}}}return n},this.linkHandle={singleLink:function(e,t,n,r,i,s){var o=[],u=e.split(";");if(u.length>0)for(var a=0;a<u.length;a++){var f=u[a],l=f.split("|");(l.length==1||l.length==2&&l[0]==r.Name||l.length==3&&l[2]==r.Name)&&o.push(f)}if(o.length>0){t=$('<a href="#"></a>').attr("data-date",n.ItemArray[0].Value).attr("data-page",e).attr("data-column",r.Name).appendTo(i);var c='{"name":"'+n.ItemArray[0].ColumnName+'","value":"'+n.ItemArray[0].Value+'"}';(function(e,t,n,r){n.click(function(n){var i=$(this).attr("data-page"),s=i.split(";"),o=t;if(s.length>1||s.length==1&&s[0].indexOf("|")>=0){var u={field:$(this).attr("data-column"),date:$(this).attr("data-date"),x:n.pageX||n.clientX,y:n.pageY||n.clientY};o.clickMenu.create(u,o,s)}else o.report.page.openPopPage(i,e,undefined,r);return!1})})("",s,t,c)}return t}},this.combins={cleateMasterRow:function(e){var t={},n=[];for(var r=0;r<e.ItemArray.length;r++){var i=e.ItemArray[r];n[r]={ColumnName:i.ColumnName,Value:""},t[i.ColumnName]=""}return t.ItemArray=n,t.setValue=function(e,t,n){for(var r=0;r<this.ItemArray.length;r++)if(e==this.ItemArray[r].ColumnName){this.ItemArray[r].Value=t,this.ItemArray[r].combinType=n;break}this[e]=t},t},init:function(e,t){var n={};if(t.Rows.length==0)return;n=this.cleateMasterRow(t.Rows[0]);for(var r in e)for(var i=0;i<t.Rows.length;i++){var s=t.Rows[i];isNaN(parseFloat(n[e[r].columnName]))&&(n[e[r].columnName]="0");var o=parseFloat(n[e[r].columnName]),u=parseFloat(s[e[r].columnName]),a=this.combinStyle[$.trim(e[r].combinType)](o,u,i);n.setValue(e[r].columnName,a,$.trim(e[r].combinType))}return n},combinStyle:{sum:function(e,t,n){return e+t},max:function(e,t,n){return e<t?t:e},min:function(e,t,n){return n==0?t:e>t?t:e},count:function(e,t,n){return n+1}}},this.pageSelecter=function(){this.pageSize=0,this.rowNum=0,this.pageCount=0,this.thisPage=1,this.PageCountPanel=""},this.pageSelecter.prototype={cumputPageCount:function(){var e=this.rowNum/this.pageSize;return e.toString().indexOf(".")!=-1&&(e=Number(e.toString().split(".")[0])+1),e},getDataScope:null,init:null,bindClickEvent:null,create:function(e){var t=e.config.getControlParam("pagesize");if(!(t&&t>0))return;e.control.empty();var n=$('<ul class="PageCount" ></ul>'),r=$("<li></li>");for(var i=0;i<this.pageCount;i++){var s=i+1;if(this.pageCount>8){if(!(this.thisPage<=5)){r.append('<a  pageIndex="'+this.PageCountPanel+'" index="1" >1</a><span>...</span>');var o=this.thisPage-2;for(var u=0;u<=4;u++){o==this.thisPage?r.append('<a  pageIndex="'+this.PageCountPanel+'" class="selectedA" index="'+o+'" > '+o+"</a>"):r.append('<a  pageIndex="'+this.PageCountPanel+'" index="'+o+'" > '+o+"</a>");if(o==this.pageCount)break;o++}if(o==this.pageCount)break;r.append('<span>...</span><a  pageIndex="'+this.PageCountPanel+'" index="'+this.pageCount+'" > '+this.pageCount+"</a>");break}if(i>=7){r.append('<span>...</span><a  pageIndex="'+this.PageCountPanel+'" index="'+this.pageCount+'" > '+this.pageCount+"</a>");break}s==this.thisPage?r.append('<a  pageIndex="'+this.PageCountPanel+'" class="selectedA" index="'+s+'" > '+s+"</a>"):r.append('<a  pageIndex="'+this.PageCountPanel+'" index="'+s+'" > '+s+"</a>")}else s==this.thisPage?r.append('<a  pageIndex="'+this.PageCountPanel+'" class="selectedA" index="'+s+'"> '+s+"</a>"):r.append('<a  pageIndex="'+this.PageCountPanel+'" index="'+s+'" > '+s+"</a>")}$("#"+this.PageCountPanel).empty(),$("#"+this.PageCountPanel).append(n.append(r)),this.bindClickEvent(e)}},this.selecterOfpage=function(){},this.selecterOfpage.prototype=new this.pageSelecter,this.selecterOfpage.prototype.init=function(e){this.PageCountPanel&&$("#"+this.PageCountPanel).remove();var t=e.config.getControlParam("pagesize");if(!t||t=="0")t=e.data.Tables[0].Rows.length;this.pageSize=Number(t),this.rowNum=e.data.Tables[0].Rows.length,this.PageCountPanel=(+(new Date)/Math.random()).toString().replace(".",""),this.pageCount=this.cumputPageCount(),e.config.getControlParam("pagesize")&&Number(e.config.getControlParam("pagesize"))>0&&$(e.control.parent()).append('<div class="PageCountPanel" id='+this.PageCountPanel+" ></div>")},this.selecterOfpage.prototype.getDataScope=function(e){var t=jQuery.extend(!0,{},e),n=this.thisPage*this.pageSize-this.pageSize,r=this.thisPage*this.pageSize;this.rowNum=e.Rows.length;if(r<=0||r>this.rowNum)r=this.rowNum;var i=e.Rows.slice(n,r);return t.Rows=i,t},this.selecterOfpage.prototype.bindClickEvent=function(e){$("[pageIndex='"+this.PageCountPanel+"']").click(function(){e.bind(null,$(this).attr("index"))})},this.selecterOfDataBase=function(){},this.selecterOfDataBase.prototype=new this.pageSelecter,this.selecterOfDataBase.prototype.init=function(e){this.PageCountPanel&&$("#"+this.PageCountPanel).remove(),psize=e.config.getControlParam("pagesize"),this.pageSize=Number(psize),this.rowNum=e.config.getControlParam("RowCount"),this.PageCountPanel=(+(new Date)/Math.random()).toString().replace(".",""),this.pageCount=this.cumputPageCount(),$(e.control.parent()).append('<div class="PageCountPanel" id='+this.PageCountPanel+" ></div>")},this.selecterOfDataBase.prototype.getDataScope=function(e){return e},this.selecterOfDataBase.prototype.bindClickEvent=function(e){$("[pageIndex='"+this.PageCountPanel+"']").click(function(){e.getPageData(this.rowNum,this.pageSize,$(this).attr("index"))})},this.getPageSelecter=function(){var e=this.config.getControlParam("isServerPager");return e?new this.selecterOfDataBase:new this.selecterOfpage},this.createGridHeader=function(e){function i(e,t,n){var r=t.split("_"),s=undefined;for(var o=0;o<e.length;o++)if(e[o].DisplayName==r[0]){s=e[o];break}s||(s={Name:"parentNode",DisplayName:r[0],Description:"parentNode",children:[]},r[1]||(s.Name=n.Name,s.DisplayName=r[0],s.Description=n.Description,s.sortStyle=n.sortStyle),e.push(s));if(r[1]){var u="";for(var o=1;o<r.length;o++)u!=""&&(u+="_"),u+=r[o];s.children=i(s.children,u,n)}return e}var t=[];for(var n=0;n<e.Columns.length;n++){var r=e.Columns[n];t=i(t,r.DisplayName,e.Columns[n])}return t}},jmreport.reportControls.register("GridViewData",jmreport.reportControls.controlTypes.gridViewData),jmreport.reportControls.register("RadGridViewData",jmreport.reportControls.controlTypes.gridViewData),jmreport.reportControls.controlTypes.eprChart=function(e){jmreport.reportControls.controlTypes.initControl.call(this,e);var t=this;this.bind=function(){var e=this.data.Tables[0];if(e.Rows.length<=0){this.log("暂无数据哦，亲！");return}this.resultModal={highChartStyle:null,series:null,categories:null,events:null},this.resultModal.series=this.getSeries(e),this.resultModal.categories=this.getCategories(e),this.resultModal.highChartStyle=this.styleHandler.get(e),this.resultModal.events=this.getEvent();var n=this.resultModal.highChartStyle;n.series=this.resultModal.series,n.xAxis.categories=this.resultModal.categories,n.plotOptions.series.events=this.resultModal.events,this.control.highcharts(n),typeof t.control.highcharts()!="undefined"&&(this.drawControl(),this.speEvent()),t.control.css("width","99%").css("overflow","hidden"),t.control.find("tspan:contains(Highcharts.com)").remove(),this.drawCompleteCallBack()},this.getHtml=function(){var e=this.control.highcharts().getSVG();return e},this.drawControl=function(){var e=95;for(var n=0;n<t.control.highcharts().series.length;n++){var r=t.control.highcharts().series[n];if(typeof r.data[0]!="undefined"&&typeof r.data[0].pointWidth!="undefined")for(var i=0;i<r.data.length;i++)r.data[i].graphic.width&&r.data[i].graphic.width>e&&(r.data[i].pointWidth=e,r.barW=e,r.data[i].graphic.width=e,$(r.data[i].graphic.element).attr("width",e),r.options.pointWidth=e)}t.control.highcharts().redraw()},this.speEvent=function(){var e=t.config.config;t.control.highcharts().series[0]&&t.control.highcharts().series[0].options.type=="pie"&&e.ShowItemLabels=="true"&&t.control.find(".highcharts-legend text").each(function(e,n){$(n).hover(function(){t.control.highcharts().tooltip.refresh(t.control.highcharts().series[0].data[e])},function(){t.control.highcharts().tooltip.hide()})})},this.getSeries=function(e){var t=[],n=this.getXconfig(e),r=this.styleHandler.getLabelStep(e.Rows.length);for(var i=0;i<n.length;i++){var s=n[i];if(s.isThisDisplay==1){var o=0;for(var u=0;u<e.Rows.length;u++){var a=e.Rows[u].ItemArray;for(var f=0;f<a.length;f++){var l=a[f];if(l.ColumnName==s.yField.Name){var c=jQuery.extend(!0,{},this.templet.lableData),h=this.styleHandler.getPointStyle(l,e,a,s,c,r,o);s=h.iItem,c=h.lableData,r=h.labelstep,o=h.stepIndex,s.data.push(c)}}}t.push(s)}}return this.spData(t)},this.spData=function(e){var t=this.styleHandler.getIsSpeStyle();switch(t){case"splinerange":case"range":var n=[{name:"范围",data:[],type:"area"+t}];for(var r=0;r<e[0].data.length;r++)n[0].data.push([this.getSeriesData(e[0].data[r]),this.getSeriesData(e[1].data[r])]);e=n.concat(e);break;case"bubble":var n=[{name:e[1].name,data:[],type:t}];for(var r=0;r<e[0].data.length;r++)n[0].data.push([this.getSeriesData(e[0].data[r]),this.getSeriesData(e[0].data[r])]);e=n}return e},this.getSeriesData=function(e){return typeof e=="object"?e.y:e},this.getXconfig=function(e){var t=this.config.config;types=this.typeMapping.get();var n=this.typeMapping.getSourceType(),r=t.ShowPointMarks.split(";"),i=this.styleHandler.getIsSpeStyle();fieldIndex=1;var s=[],o=[],u=0;for(var a=fieldIndex;a<e.Columns.length;a++){var f=jQuery.extend(!0,{},this.templet.xAxis),l=e.Columns[a];this.typeNameIsNumber(l.DataType)&&(f.name=l.DisplayName,f.yField=l,f.field=l,f.isThisDisplay=!0,f.index=l.Index,i&&(new RegExp("^(stackedbar{1,1})([100]{0,1})")).test(i)?(f.type="column",n[a-1]=="Bar"?f.stack=0:f.stack=1):types[a-1]?(f.type=types[a-1],f.sourceType=n[a-1],o=[types[a-1],n[a-1]]):(f.type=o[0],f.sourceType=o[1]),i=="radar"&&(f.type="area"),t.IsAxis2Y&&u>=Number(t.IsAxis2Y)&&(f.yAxis=1),r[u]=="true"&&(f.showLabel=!0),fieldIndex++,u++),s.push(f)}return s},this.getCategories=function(e){var t=[];for(var n=0;n<e.Rows.length;n++){var r=e.Rows[n].ItemArray;for(var i=0;i<r.length;i++){var s=r[i];s.ColumnName==e.Columns[0].Name&&t.push(s.Value)}}return t},this.typeMapping={list:{bar:"column",stackedbar100:"column",stackedbar:"column",radar:"line",horizontalbar:"bar",horizontalstackedbar:"bar",horizontalstackedbar100:"bar",stackedarea:"area",stackedarea100:"area",doughnut:"pie",range:"line",splinerange:"spline"},getSourceType:function(){return t.config.config.DefaultChartType?t.config.config.DefaultChartType.split(";"):["line"]},get:function(e){var e=this.getSourceType(),t=[];for(var n=0;n<e.length;n++){var r=e[n].toLowerCase();this.list[r]&&(r=this.list[r]),t.push(r)}return t}},this.styleHandler={getPointStyle:function(e,n,r,i,s,o,u){var a={iItem:null,lableData:null,labelstep:0,stepIndex:0};i.showLabel?(s.dataLabels.enabled=!0,t.templet.stackSeries.dataLabels.enabled=!0,t.templet.highCharts.yAxis.stackLabels=!0):i.type!="scatter"&&(s.marker.radius=0);if(o!=n.Rows.length&&i.showLabel==1){if(u!=0||Number(e.Value)==0)s.dataLabels.enabled=!1,s.marker.radius=2;u++,u==o&&(u=0)}return s.y=Number(e.Value),i.type=="pie"&&(s.x=r[2].Value,s.name=r[2].Value),a.iItem=i,a.labelstep=o,a.lableData=s,a.stepIndex=u,a},getLabelStep:function(e){return e>10?Math.floor(e/10):e},get:function(e){var n=t.config.config,r=jQuery.extend(!0,{},t.templet.highCharts),i=this.getIsSpeStyle();i&&(r=this.setSpeStyle(i,r));var s=n.DefaultLabelFormat||"yyyy-MM-dd";r.xAxis.dateTimeLabelFormats={millisecond:s,second:s,minute:s,hour:s,day:s,week:s,month:s,year:s};var o=this.getLabelStep(e.Rows.length);e.Rows.length>1e3?r.xAxis.tickInterval=o:e.Rows.length!=o&&(r.xAxis.labels.step=o,r.xAxis.labels.rotation=.1);if(n.IsAxis2Y){var u=jQuery.extend(!0,{},r.yAxis[0]);u.opposite=!0,r.yAxis.push(u)}n.LabelRotationAngle&&(r.xAxis.labels.align="left",r.xAxis.labels.rotation=n.LabelRotationAngle),n.ShowItemLabels=="false"&&(r.tooltip.shared=!1,r.tooltip.crosshairs=!1,r.tooltip.enabled=!1);var a=n.ChartLegendPosition?n.ChartLegendPosition.toLowerCase():"right",f="top";return a=="bottom"&&(f="bottom",a="center"),r.legend={layout:a=="left"||a=="right"?"vertical":"horizontal",align:a,verticalAlign:f,borderWidth:0,padding:5},f=="top"&&a!="right"&&(r.legend.margin=25),f=="top"&&a=="right"&&(r.legend.y=-25,r.legend.margin=0),r.plotOptions.series.animation=r.chart.animation=t.config.config.EnableAnimations!="false",t.config.config.Height==0&&(t.config.config.Height=350,t.control.height(t.config.config.Height)),t.config.config.Height<350&&(r.plotOptions.pie.size=t.config.config.Height/100*78),r},getIsSpeStyle:function(){var e=!1,n=t.typeMapping.getSourceType();for(var r=0;r<n.length;r++){var i=n[r].toLowerCase();e=this.decide(i)}return e},decide:function(e){return(new RegExp("^(stackedbar{1,1})([100]{0,1})")).test(e)||e=="radar"||e=="horizontalbar"||(new RegExp("^(horizontalstackedbar{1,1})([100]{0,1})")).test(e)||(new RegExp("^(stackedarea{1,1})([100]{0,1})")).test(e)||e=="doughnut"||e=="range"||e=="splinerange"||e=="bubble"?e:!1},setSpeStyle:function(e,n){switch(e){case"stackedarea":case"stackedarea100":case"horizontalstackedbar100":case"horizontalstackedbar":case"stackedbar100":case"stackedbar":n.plotOptions.series=t.templet.stackSeries,(new RegExp("^(horizontalstackedbar{1,1}|stackedarea{1,1}|stackedbar{1,1})([100]{1,1})")).test(e)&&(n.plotOptions.series.stacking="percent"),(new RegExp("^(horizontalstackedbar{1,1})([100]{0,1})")).test(e)&&(n.xAxis.labels.align="right"),(new RegExp("^(stackedarea{1,1})([100]{0,1})")).test(e)&&(n.plotOptions.series.dataLabels.y=20);break;case"radar":n.chart.polar=!0,n.xAxis.tickmarkPlacement="on",n.xAxis.lineWidth=0,n.yAxis[0].minorTickInterval="auto",n.yAxis[0].gridLineInterpolation="polygon",n.yAxis[0].lineWidth=0;break;case"horizontalbar":n.xAxis.labels.align="right";break;case"doughnut":n.plotOptions.series={innerSize:"50%"}}return n}},this.getEvent=function(){return this.templet.events},this.templet={xAxis:{name:"",field:"",isThisDisplay:"",xIsDate:"",data:[],showInLegend:!0,type:"",sourceType:"",yAxis:0,index:0,showLabel:!1},lableData:{dataLabels:{crop:!1,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"#000"},marker:{enabled:!0,radius:3,lineWidth:1,states:{hover:{enabled:!0,radius:5}}},y:0},stackSeries:{stacking:"normal",groupPadding:.1,zIndex:-1,dataLabels:{color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"#000"}},events:{click:function(e){}},highCharts:{colors:["#058DC7","#50B432","#ED561B","#DDDF00","#24CBE5","#64E572","#FF9655","#FFF263","#6AF9C4"],chart:{polar:!1,zoomType:"xy",spacing:[30,30,25,30],style:{position:"absolute"}},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",gridLineWidth:0,lineColor:"#454545",tickColor:"#454545",tickmarkPlacement:"on",startOnTick:!1,ordinal:!1,labels:{align:"center",formatter:function(){var e=new RegExp("^[0-9]{4,4}-[0-9]{2,2}-[0-9]{2,2}[~]{1,1}[0-9]{4,4}-[0-9]{2,2}-[0-9]{2,2}");if(e.test(this.value.toString()))return this.value;e=new RegExp("^[0-9]{4,4}-[0-9]{2,2}-[0-9]{2,2}|^[0-9]{2,2}-[0-9]{2,2}%|^[0-9]{2,2}-[0-9]{2,2}-[0-9]{2,2}%|^([0-9]{2,2}:[0-9]{2,2}){1,1}|^([0-9]{2,2}:[0-9]{2,2}:[0-9]{2,2}){1,1}");if(e.test(this.value.toString())){var t=parseDate(this.value);return t.toString()=="Invalid Date"?this.value:formatDate(t,this.dateTimeLabelFormat)}return this.value}}},yAxis:[{title:{text:""},minorTickInterval:0,lineColor:"#fff",stackLabels:{style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"#000"}}}],tooltip:{shared:!0,crosshairs:!0,useHTML:!0},plotOptions:{series:{cursor:"pointer",groupPadding:.1,dataLabels:{formatter:function(){return formatNumber(this.y)}}},pie:{allowPointSelect:!0,dataLabels:{enabled:!1,format:"{point.x}:{point.percentage:.1f} %",connectorColor:"#cccccc",connectorPadding:2,connectorWidth:1,distance:10,color:"#545454",y:-10},states:{hover:{enabled:!1}}},spline:{pointPadding:0,borderWidth:0,turboThreshold:2e3,marker:{radius:0}},line:{pointPadding:0,borderWidth:0,turboThreshold:2e3,marker:{radius:0}}}}}},jmreport.reportControls.register("ChartXY",jmreport.reportControls.controlTypes.eprChart),jmreport.reportControls.register("ChartXYTab",jmreport.reportControls.controlTypes.eprChart),jmreport.reportControls.controlTypes.gridSparkLine=function(e){jmreport.reportControls.controlTypes.gridViewData||alert("在使用“jmreport.reportControls.gridSparkLine”之前请引入“jmreport.reportControls.gridViewData”!"),jmreport.reportControls.controlTypes.gridViewData.call(this,e);var t=this;this.createTable=function(e,t){t||(t=this.createGridHeader(e));var n=$('<table cellspacing="0" cellpadding="0" border="0" class="jmreport-gridViewData jmreport-gridSparkLine"></table>'),r=$("<tr></tr>").appendTo($("<thead></thead>").appendTo(n));for(var i=0;i<t.length;i++){if(i==3||i==5)continue;var s=t[i],o=s.DisplayName;$.trim(s.Description)!=""&&(o+="<span class='cDescription' title='"+s.Description+"' >?<span>"),$("<th></th>").appendTo(r).html(o)}$("<th>查看明细</th>").appendTo(r);var u=$("<tbody></tbody>").appendTo(n),a=e.Rows.length;for(var i=0;i<a;i++){var f=e.Rows[i],l=$("<tr></tr>").appendTo(u),c=t.length;for(var h=0;h<c;h++){if(h==3||h==5)continue;var s=t[h],p=$("<td></td>").appendTo(l),d=f.ItemArray.length;for(var v=0;v<d;v++){var m=f.ItemArray[v];if(m.ColumnName==s.Name){if(h==2&&m.Value){var g=[{name:s.DisplayName,showInLegend:!1,data:[]}],y=[],b="",w="",E="";m.Value.indexOf("❻")!=-1&&m.Value.indexOf("❽")!=-1?(b=m.Value.split("❻")[0],w=m.Value.split("❻")[1].split("❽")[0],E=m.Value.split("❻")[1].split("❽")[1]):m.Value.indexOf("❻")!=-1&&m.Value.indexOf("❽")==-1?(b=m.Value.split("❻")[0],w=m.Value.split("❻")[1]):b=m.Value;var S=b,x=S.split(","),T=x.length;for(var N=0;N<T;N++){if(!x[N])continue;var C=x[N].split("|");y.push(C[0]),g[0].data.push(Number(C[1]))}var k=$('<div class="chart"></div>').appendTo(p);k.width(220),k.height(50),p.width(220),this.renderLine(k,y,g,!1);var L=this.createChartData.get(b,w,E);y=L.categories,g=L.series;var A=this;(function(e,t,n){n.find("svg").click(function(){A.popPageChart(e,t,A)})})(y,g,k);break}m.Value==""&&(m.Value="&nbsp;");var O=m.Value;h==4?O="<b>"+f.ItemArray[3].Value+"</b><br /><span>"+O+"</span>":h==6&&(O="<b>"+f.ItemArray[5].Value+"</b><br /><span>"+O+"</span>"),m.combinType?(p.html("<div>"+O+"</div>"),p.attr("class","combin")):p.html(O);if(h==c-1){var M=$("<td></td>").appendTo(l),A=this;(function(e,t){$('<a href="#"></a>').appendTo(M).click(function(){A.popPageChart(e,t,A)}).html("查看明细")})(y,g)}break}}}}return n},this.createChartData={findMark:function(e){var t=e.split(","),n=[],r={maxIndex:0,minIndex:0,nowIndex:t.length-1};for(var i=0;i<t.length;i++){if(!t[i])continue;var s=t[i].split("|");n.push({data:Number(s[1]),index:i})}return n=n.sort(function(e,t){return t.data-e.data}),r.maxIndex=n[0].index,n=n.sort(function(e,t){return e.data-t.data}),r.minIndex=n[0].index,r},get:function(e,n,r){var i={categories:[],series:[]},s=this.findMark(e),o=e.split(","),u=n.split(","),a=r.split(","),f=jQuery.extend(!0,{},t.templet.xAxis),l=jQuery.extend(!0,{},t.templet.xAxis),c=jQuery.extend(!0,{},t.templet.xAxis);f.name="今天";for(var h=0;h<o.length;h++){if(!o[h])continue;var p=o[h].split("|");i.categories.push(p[0]);if(h==s.maxIndex||h==s.minIndex||h==s.nowIndex){var d=jQuery.extend(!0,{},t.templet.lableData);d.dataLabels=t.styleHandler.getLabelStyle(h,s),d.y=Number(p[1]),f.data.push(d)}else f.data.push(Number(p[1]))}l.name="昨天";for(var h=0;h<u.length;h++){if(!u[h])continue;var p=u[h].split("|");l.data.push(Number(p[1]))}c.name="上周";for(var h=0;h<a.length;h++){if(!a[h])continue;var p=a[h].split("|");c.data.push(Number(p[1]))}return i.series.push(f),i.series.push(l),i.series.push(c),i}},this.popPageChart=function(e,t,n){var r=$('<div class="jmreport-poppage"></div>');r.appendTo("body"),r.dialog({autoOpen:!1,modal:!0,width:"800",height:"450",title:"查看明细"}),r.dialog("open"),r.css("margin","20px"),n.renderLine(r,e,t,!0)},this.renderLine=function(e,t,n,r){var i=this.styleHandler.get(t,n,r);i.series=n,i.xAxis.categories=t,e.highcharts(i),e.find("tspan:contains(Highcharts.com)").hide()},this.styleHandler={getLabelStep:function(e){return e>5?Math.floor(e/5):e},getLabelStyle:function(e,t){var n="";e==t.maxIndex&&(n="最大值"),e==t.minIndex&&(n!=""&&(n+="/"),n+="最小值"),e==t.nowIndex&&(n!=""&&(n+="/"),n+="当前值"),n+="：";var r={enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"#000000",format:n+"{y}",crop:!1};return r},get:function(e,n,r){var i=jQuery.extend(!0,{},t.templet.chartTemplet);return r&&(i.xAxis.tickLength=5,i.xAxis.lineWidth=1,i.xAxis.labels.formatter=function(){return this.value},i.yAxis.tickLength=5,i.yAxis.lineWidth=0,i.yAxis.gridLineWidth=1,i.yAxis.labels.formatter=function(){return this.value},e.length>5&&(i.xAxis.labels.rotation=.1),i.xAxis.tickInterval=this.getLabelStep(e.length),i.legend={layout:"center",align:"right",verticalAlign:"middle",borderWidth:0,padding:0},i.chart.zoomType="xy",i.tooltip.shared=!0,i.tooltip.crosshairs=!0,i.tooltip.enabled=!0),i}},this.templet={lableData:{dataLabels:{enabled:!0},marker:{enabled:!0,radius:2,states:{hover:{enabled:!0,radius:5}}},y:54.4},xAxis:{name:"",data:[],showInLegend:!0},chartTemplet:{colors:["#058DC7","#50B432","#ED561B","#DDDF00","#24CBE5","#64E572","#FF9655","#FFF263","#6AF9C4"],chart:{type:"spline"},title:{text:""},subtitle:{text:""},xAxis:{title:{text:""},tickLength:0,lineWidth:0,type:"datetime",tickmarkPlacement:"on",startOnTick:!1,ordinal:!1,tickInterval:99999,labels:{formatter:function(){return""}}},yAxis:{title:{text:""},tickLength:0,lineWidth:0,gridLineWidth:0,labels:{formatter:function(){return""}}},plotOptions:{spline:{lineWidth:1,states:{hover:{lineWidth:1}},marker:{enabled:!1,radius:0}}},tooltip:{shared:!1,crosshairs:!1,enabled:!1}}}},jmreport.reportControls.register("GridSparkLine",jmreport.reportControls.controlTypes.gridSparkLine),jmreport.reportControls.controlTypes.itemCompareList=function(e){jmreport.reportControls.controlTypes.initControl.call(this,e),this.createItem=function(e){var t=$('<ul class="jmreport-itemCompareList-item"></ul>'),n="<span class='cDescription' title='"+e.description+"' >?<span>";$('<li class="item-title"></li>').appendTo(t).html(e.title+n).attr("title",e.description);var r=$('<li class="item-value"></li>').appendTo(t).html(e.value);if(e.compares&&e.compares.length>0){var i=$("<li></li>").appendTo(t);for(var s=e.compares.length-1;s>-1;s--){var o=e.compares[s],u=$('<div class="compare-item"></div>').appendTo(i);$("<label></label>").appendTo(u).html(o.name);var a=$("<span></span>").appendTo(u).html(o.value).attr("title",o.description);o.value.indexOf("-")!=-1?a.toggleClass("red",!0):a.toggleClass("green",!0)}}return t},this.bind=function(){this.control.empty();var e=this.data.Tables[0];if(e.Rows.length<=0){this.log("暂无数据哦，亲！");return}var t=$('<ul class="jmreport-itemCompareList"></ul>');for(var n=0;n<e.Rows.length;n++){var r=e.Rows[n],i={date:r.ItemArray[0].Value},s=e.getColumnMapping(r.ItemArray[1].Value);s||(s=e.getColumnMapping(r.ItemArray[2].ColumnName)),i.title=s.DisplayName,i.description=s.Description,i.value=jmreport.helper.convertUnit(r.ItemArray[2].Value),this.config.config.BaseUnitsX&&(i.value+=this.config.config.BaseUnitsX),i.compares=[];if(r.ItemArray.length>3)for(var o=3;o<r.ItemArray.length;o++){var u=r.ItemArray[o],a=e.getColumn(u.ColumnName);i.compares.push({name:a.DisplayName||a.Name,description:a.Description,value:u.Value})}var u=this.createItem(i),f=$("<li></li>").appendTo(t);n==e.Rows.length-1&&f.toggleClass("last",!0),u.appendTo(f)}t.appendTo(this.control),t.css("height","auto"),t.parent().css("height","auto"),this.drawCompleteCallBack()}},jmreport.reportControls.register("OneTextItemCompareList",jmreport.reportControls.controlTypes.itemCompareList),jmreport.reportControls.controlTypes.label=function(e){jmreport.reportControls.controlTypes.initControl.call(this,e),this.title.hide();var t=this;this.bind=function(){var e=this.data.Tables[0];if(e.Rows.length<=0){this.log("暂无数据哦，亲！");return}var t=this.styleHandler.get();this.control.attr("style",t);var n=$('<span class="jmreport-control-label"></span>');n.html(e.Rows[0].ItemArray[0].Value),this.control.empty(),n.appendTo(this.control),this.drawCompleteCallBack()},this.styleHandler={get:function(){var e="";if(t.config.config.ControlPara){var n=t.config.config.ControlPara.split("|");for(var r in n)n[r]&&(e+=this.styleSwitch(n[r])+";")}return e},styleSwitch:function(e){var t=e.split("="),n="";switch(t[0]){case"FontSize":n=" font-size:"+t[1]+"px";break;case"FontWeight":n=" font-weight:"+t[1];break;case"Foreground":n=" color:"+t[1].replace("#FF","#");break;case"TextWrapping":t[1]=="Wrap"?n=" white-space:normal":n=" white-space:nowrap"}return n}}},jmreport.reportControls.register("Title",jmreport.reportControls.controlTypes.label),jmreport.reportControls.controlTypes.imageBox=function(e){jmreport.reportControls.controlTypes.initControl.call(this,e),this.title.hide();var t=this;this.bind=function(){var e=this.data.Tables[0];if(e.Rows.length<=0){this.log("暂无数据哦，亲！");return}$('<img src="'+this.config.config.LinkPageID+'" />').appendTo(this.control),this.drawCompleteCallBack()}},jmreport.reportControls.register("ImageBox",jmreport.reportControls.controlTypes.imageBox),jmreport.reportControls.controlTypes.dataViewDatePick=function(e){jmreport.reportControls.controlTypes.initControl.call(this,e);var t=this;this.bind=function(){var e=this.data.Tables[0];if(e.Rows.length<=0){this.log("暂无数据哦，亲！");return}var t={theme:!0,header:{left:"prev,next today",center:"title",right:"month,basicWeek,basicDay"},editable:!0};t.events=this.createData(e),this.control.fullCalendar(t),this.drawCompleteCallBack()},this.createData=function(e){var t=[];for(var n=0;n<e.Rows.length;n++){var r=jQuery.extend(!0,{},this.templet.event);r.start=parseDate(e.Rows[n].Date),r.title=e.Rows[n].Value,t.push(r)}return t},this.templet={event:{title:"title",start:new Date}}},jmreport.reportControls.register("DataViewDatePick",jmreport.reportControls.controlTypes.dataViewDatePick)
